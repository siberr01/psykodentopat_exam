---
title: "Report for psykodentopat"
author: "Hilde Kollsete Gjelberg, Ingrid Eline Holm, and Simen Berrefjord"
date: "`r Sys.Date()`"
output: 
  html_document:
    toc: true
    toc_float: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

This is a R Markdown report for the group exam in RMED901A for the group psykodentopat. The group consists of Hilde Kollsete Gjelberg, Ingrid Eline Holm, and Simen Berrefjord.

The report includes all the steps we have conducted throughout the course related to the exam data (i.e., exploration, tidying, visualization, and statistical analyses).

```{r packages, include=FALSE}
library(tidyverse)
library(here)
library(ggplot2)
library(patchwork)
```

```{r read data, include=FALSE}
exam_data <- read_delim(here("data", "exam_data.txt"))
exam_data_join <- read_delim(here("data", "exam_data_join.txt"))
joined_exam_data <- read_delim(here("data", "joined_exam_data_2025-09-09.txt"))
```

## Data exploration: Original dataset
To get an overview of the dataset, we inspected its structure and content using 
tidyverse functions such as `glimpse()`, the base R function str(), and the skim() function from the skimr package. In the following, we illustrate the output using skim(). 
```{r}
skimr::skim(exam_data)
```

```{r, echo=TRUE, eval=FALSE}
exam_data
glimpse(exam_data)
str(exam_data)
head(exam_data)
tail(exam_data)
```
The dataset contains 265 rows and 20 columns. Each row represents one patient observation. The variables can be grouped as follows:  

- **Identifiers and demographics:** `patient_id`, `preOp_gender`, `preOp_age`, `BMI kg/m2`, `preOp_smoking`  
- **Preoperative information:** `preOp_pain`, `preOp_ASA_Mallampati`  
- **Treatment allocation:** `treat`  
- **Postoperative outcomes:** repeated measures of `cough`, `throatPain`, and `swallowPain` recorded at several time points (`pacu30min`, `pacu90min`, `postOp4hour`, `pod1am`)  
- **Other variables:** `month`, `year`  

Most variables in the dataset can be divided into numeric and categorical variables: 

- **Numeric variables:**  
  `preOp_age`, `BMI kg/m2`, and several outcome variables (e.g., `pacu30min_cough`, `pacu90min_throatPain`, `postOp4hour_swallowPain`).

- **Categorical variables:**  
  `preOp_gender`, `1gender`, `preOp_smoking`, `preOp_pain`, `preOp_ASA_Mallampati`, and `treat`.

### Observations
From the initial inspection we noted several issues:

- Many variables were unnecessarily prefixed with "preOp_" (gender, age, smoking, pain).
- The column `BMI kg/m2`did not have a tidy variable name, as it contained spaces and special characters; should be renamed.
- There were two separate gender columns ("`preOp_gender` and "`1gender`).
- Several column names included both measurement time and the type of observation in the same variable name (e.g., "`pacu30min_cough`, "`pacu30min_throatPain`), indicating that the dataset was in wide format.
- The variables `month` and `year` were not mentioned in the codebook, might refer to month/year of operation, but might be something else as well.
- The column `preOp_ASA_Mallampati` contained two measures (ASA (American Society of Anesthesiologists) physical status and Mallampati score).
- Several columns appeared as numeric (e.g., 0/1 for gender, 1/2/3 for smoking), but on inspection they represented categorical values and should be converted into factors with descriptive labels.

### Patient IDs
We next examined the patient identifiers to check for duplicates. Although the dataset contains 265 rows, there are only **235 unique patient IDs**, which means that some patients are represented more than once.  
```{r}
exam_data %>%
  count(patient_id) %>%
  distinct()
```

Further inspection showed that **28 patients are recorded twice** and **2 patients appear three times**:
```{r}
exam_data %>%
  count(patient_id) %>%
  filter(n > 1)

exam_data %>%
  count(patient_id) %>%
  filter(n > 2)
```

By pulling the IDs that occur more than once, we confirmed that these represent patients who underwent surgery on multiple occasions (different month/year):
```{r}
exam_data %>%
  count(patient_id) %>%
  filter(n > 1) %>%
  pull(patient_id)
```

## Tidying of data: Original dataset

### Renaming of columns
Several variables were renamed to make the dataset easier to work with and more consistent with tidy data principles. In particular, the unnecessary "preOp_" prefix was removed from baseline variables and the column `"BMI kg/m2"` was given a tidy name without spaces or special characters.  
```{r}
exam_data <- exam_data %>%
  rename(
    gender = preOp_gender,
    smoking = preOp_smoking,
    BMI = "BMI kg/m2",
    swallowPain = pacu30min_swallowPain,
    age = preOp_age
  )
```

### Removing duplicate columns
During the initial inspection we found that gender was recorded in two separate columns (`preOp_gender` and `1gender`). After checking, these two variables were identical. To avoid redundancy and potential confusion, we kept the renamed `gender` column and removed `1gender` from the dataset.  
```{r, echo=TRUE, eval=FALSE}
exam_data$gender == exam_data$`1gender`

exam_data <- exam_data %>%
  select(-`1gender`)
```

### Restructuring data (to long format)
Several outcome variables (e.g., `cough`, `throatPain`) were originally stored in **wide format**, with both the time point and the symptom encoded in the column names (e.g., `pacu30min_cough`, `postOp4hour_throatPain`).  

To make the dataset tidy, we first used "pivot_longer()" to gather these columns into two new variables:  
- `time_final`, capturing the measurement occasion  
- `symptom`, capturing the type of observation (cough or throat pain)  
The corresponding values were stored in the column `value`.  

Next, we applied "pivot_wider()" to spread the `symptom` variable back into separate columns (`cough` and `throatPain`), so that each row corresponds to one patient at one time point, with both outcomes recorded. Finally, we renamed `time_final` to `time` for clarity.  
```{r}
exam_data_clean <- exam_data %>%
  pivot_longer(
    cols = matches("cough|throatPain"),
    names_to = c("time_final", "symptom"),
    names_sep = "_",
    values_to = "value"
  ) %>%
  pivot_wider(
    names_from = symptom,
    values_from = value
  )

exam_data_clean <- exam_data_clean %>%
  rename(time = time_final)
```

### Removing `month` and `year`
The variables `month` and `year` were included in the dataset, but their meaning was unclear and they were not documented in the accompanying notes. Since they are not needed for the planned analyses, these columns were removed.  
```{r}
exam_data_clean <- exam_data_clean %>%
  select(-month, -year)
```

### Separating ASA_Mallampati to ASA and mallampati
The column `preOp_ASA_Mallampati` contained two pieces of information combined in a single field:  
- ASA classification (American Society of Anesthesiologists physical status), and  
- Mallampati score (airway assessment).  

To make the dataset tidy, these measures were separated into two distinct variables (`ASA` and `mallampati`) using "separate()".
```{r}
exam_data_clean <- exam_data_clean %>%
  separate(preOp_ASA_Mallampati,
    into = c("ASA", "mallampati"),
    sep = "_"
  )

exam_data_clean %>%
  count(ASA, mallampati)
```

### Converting variabels from numeric to factor
Several variables in the dataset were originally coded as numbers, but represented categorical information. To make the dataset tidy and improve interpretability, these variables were converted into factors with descriptive labels:  

- `cough`: recoded from values 0–3 into "no", "mild", "moderate", and "severe"  
- `gender`: recoded from 0/1 into "M" and "F"  
- `smoking`: recoded from 1/2/3 into "current", "past", "never"  
- `preOp_pain`: recoded from 0/1 into "no", "yes"  
- `treat`: recoded from 0/1 into "Sugar" and "Licorice"  
- `ASA`: recoded into a factor with three levels (1–3)  
- `mallampati`: recoded into a factor with four levels (1–4)  

This ensures that categorical variables are treated appropriately during analysis and improves the readability of results.
```{r}
exam_data_clean <- exam_data_clean %>%
  mutate(cough = factor(
    cough,
    levels = c(0, 1, 2, 3),
    labels = c("no", "mild", "moderate", "severe")
  ))

exam_data_clean <- exam_data_clean %>%
  mutate(
    gender = factor(
      gender,
      levels = c(0, 1),
      labels = c("M", "F")
    )
  )

exam_data_clean <- exam_data_clean %>%
  mutate(
    smoking = factor(
      smoking,
      levels = c(1, 2, 3),
      labels = c("current", "past", "never")
    )
  )

exam_data_clean <- exam_data_clean %>%
  mutate(preOp_pain = factor(
    preOp_pain,
    levels = c(0, 1),
    labels = c("no", "yes")
  ))

exam_data_clean$treat <- factor( # Convert the variable `treat` into a factor with two levels:
  exam_data_clean$treat,
  levels = c(0, 1), # 0 = "Sugar 5g" and 1 = "Licorice 0.5g"
  labels = c("Sugar", "Licorice")
)

exam_data_clean %>%
  mutate(
    ASA = factor(ASA, levels = 1:3),
    mallampati = factor(mallampati, levels = 1:4)
  )
```

## Data exploration: Additional dataset
We inspected the additional dataset using the same functions as for the original dataset, illustrated in the output using skim().
```{r, include=FALSE}
exam_data_join
glimpse(exam_data_join)
str(exam_data_join)
head(exam_data_join)
tail(exam_data_join)
```

```{r}
skimr::skim(exam_data_join)
```
The additional dataset contains 245 rows and 3 columns. patient_id is identifier. 
All three variables; `patient_id`, `intraOp_surgerySize` and `extubation_cough`, are stored as numeric.

### Observations
- The additional dataset contains 245 patients, slightly fewer than in the main dataset (265).
- `intraOp_surgerySize` and `extubation_cough` represent categorical or ordinal information and will need to be converted to factors with meaningful labels.
- Two missing values were observed in extubation_cough.

Before joining this dataset with the main dataset, we tidied it. 

## Tidying of data: Additional dataset
### Converting variabels from numeric to factor
The variables `intraOp_surgerySize` and `extubation_cough` were converted to factors with descriptive labels.  
```{r}
exam_data_join <- exam_data_join %>%
  mutate(intraOp_surgerySize = factor(
    intraOp_surgerySize,
    levels = c(1, 2, 3),
    labels = c("small", "medium", "large")
  ))

exam_data_join <- exam_data_join %>%
  mutate(extubation_cough = factor(
    extubation_cough,
    levels = c(0, 1, 2, 3),
    labels = c("no cough", "mild", "moderate", "severe")
  ))
```

### Checking for duplicates in both data sets
Before joining the two datasets (`exam_data_clean` and `exam_data_join`) we checked for and removed duplicate row to ensure that each patient ID was represented only once per dataset.

```{r}
nrow(exam_data_clean)
distinct(exam_data_clean)

exam_data_clean <- exam_data_clean %>%
  distinct()

nrow(exam_data_clean)

nrow(exam_data_join)
distinct(exam_data_join)

exam_data_join <- exam_data_join %>%
  distinct()

nrow(exam_data_join)
```
After removing duplicates, the cleaned datasets contained **940 rows** ("exam_data_clean") and **235 rows** ("exam_data_join").

## Joined dataset
### Joining
The additional dataset ("exam_data_join") was then merged with the main dataset ("exam_data_clean") using a **left join** on `patient_id`.  
A left join was chosen to ensure that all patients from the main dataset were retained, even if no matching record was available in the additional dataset.
After joining, we used "glimpse()" to quickly inspect the structure of the combined dataset.  
```{r}
joined_exam_data <- exam_data_clean %>%
  left_join(exam_data_join)
```

```{r, echo=TRUE, eval=FALSE}
glimpse(joined_exam_data)
```

### Tidying the joined dataset
#### Renaming of columns
Unnecessary "intraOp_" prefix was removed from `intraOp_surgerySize` column. 
```{r}
joined_exam_data <- joined_exam_data %>%
  rename(
    surgerySize = intraOp_surgerySize,
  )
```

#### Recoding ASA and Mallampati to factors
As for the main dataset, `ASA` and `Mallampati` were converted into factors with three and four levels respectively. 
```{r}
joined_exam_data <- joined_exam_data %>%
  mutate(ASA = factor(
    ASA,
    levels = c(1, 2, 3),
    labels = c("healthy", "mild", "severe")
  ))

joined_exam_data <- joined_exam_data %>%
  mutate(mallampati = factor(
    mallampati,
    levels = c(1, 2, 3, 4),
    labels = c("soft palate, fauces, uvula, pillars visible", "soft palate, fauces, uvula visible", "soft palate, base of uvula visible", "soft palate not visible at all")
  ))
```

#### Changing from character to factor
Variables coded as characters were converted into factors:  
```{r}
joined_exam_data <- joined_exam_data %>%
  mutate(across(where(is.character), as.factor))
```

#### Creation of new columns
To evaluate changes in symptoms over time, two new variables were created:  

- **`throat_pain_change`**: compares throat pain at "pacu30min" and "pod1am" for each patient, and categorises the change as *increased*, *decreased*, or *no_change*.  
- **`cough_change`**: compares cough status at extubation with cough at "pod1am". Patients were categorised as *no_change*, *more_cough*, *cough_resolved*, or *persistent_cough*.  

These derived variables allow symptom progression to be analysed more easily.
```{r}
throat_pain_change <- joined_exam_data %>%
  select(patient_id, time, throatPain) %>%
  filter(time %in% c("pacu30min", "pod1am")) %>%
  pivot_wider(names_from = time, values_from = throatPain) %>%
  mutate(throat_pain_change = case_when(
    pod1am > pacu30min ~ "increased",
    pod1am < pacu30min ~ "decreased",
    pod1am == pacu30min ~ "no_change"
  )) %>%
  select(patient_id, throat_pain_change)

cough_change <- joined_exam_data %>%
  filter(time == "pod1am") %>%
  mutate(cough_change = case_when(
    extubation_cough == "no cough" & cough == "no" ~ "no_change",
    extubation_cough == "no cough" & cough %in% c("mild", "moderate", "severe") ~ "more_cough",
    extubation_cough %in% c("mild", "moderate", "severe") & cough == "no" ~ "cough_resolved",
    extubation_cough %in% c("mild", "moderate", "severe") & cough %in% c("mild", "moderate", "severe") ~ "persistent_cough"
  )) %>%
  select(patient_id, cough_change)
```

#### Finalising the joined dataset
In a single pipeline, we combined the newly created outcome variables with the main dataset, derived BMI categories, and organised the dataset for further analysis:  

- `throat_pain_change` and `cough_change` were joined by `patient_id`.  
- A categorical variable `BMI_category` was created by grouping BMI values into four ranges (*Underweight*, *Normal weight*, *Overweight*, *Obese*).  
- Columns were reordered to place core patient variables (`patient_id`, `BMI`, `age`, `smoking`, `gender`) first.  
- The dataset was arranged by `patient_id` for clarity.  
```{r}
joined_exam_data <- joined_exam_data %>%
  left_join(throat_pain_change, by = "patient_id") %>%
  left_join(cough_change, by = "patient_id") %>%
  mutate(BMI_category = cut(BMI,
    breaks = c(-Inf, 18.5, 25, 30, Inf),
    labels = c("Underweight", "Normal weight", "Overweight", "Obese"),
    right = FALSE
  )) %>%
  select(patient_id, BMI, age, smoking, gender, everything()) %>%
  arrange(patient_id)
```

#### Exploration of the joined data 
We explored the joined dataset using "skim()" and summarised missing values across all variables.  
Eight missing values were identified in `swallowPain`, `cough`, `throatPain`, and `extubation_cough`.  
Since the dataset is in long format, these correspond to only two individuals.  
```{r, echo=TRUE, eval=FALSE}
skimr::skim(joined_exam_data)
```

```{r}
joined_exam_data %>%
  summarise(across(everything(), ~ sum(is.na(.)))) %>% # Showing were we have missing values
  pivot_longer(
    cols = everything(),
    names_to = "variable",
    values_to = "n_missing"
  ) %>%
  arrange(desc(n_missing))
```


## Visualization
The next part of our project concerned visualization. We used the joined_exam_data_2025-09-09.txt.   
Our task was to create plots to answer the following questions: 

### **1. Are there any correlated measurements?**  

To explore potential relationships between the variables, we created a correlation matrix.  
The `patient_id` collumn was excluded because it is just an identifier and does not carry meaningful information for correlation analysis.  
```{r reading data, include=FALSE}
library(tidyverse)
library(here)
library(ggplot2)
library(patchwork)
joined_exam_data <- read_delim(here("data", "joined_exam_data_2025-09-09.txt"))
```

```{r warning = FALSE}
joined_exam_data %>%
  select(-patient_id) %>%
  GGally::ggcorr()
```
  
This correlation matrix demonstrates a strong positive correlation between `swallowPain` and `throatPain`.`BMI` and `age` appears to have a weak positive correlation.  
  
  
### **2.  Does the age distribution depend on treatmeant-group?**  
To investigate whether age distribution differs between treatment groups, we created a density plot stratified by treatment.  

```{r ggplot patient age treatment, include=FALSE}
ggplot <- ggplot(joined_exam_data, aes(x = age, fill = treat)) +
  geom_density(alpha = 0.5) +
  theme_gray() +
  labs(
    title = "Age distribution by treatment",
    x = "Patient age",
    fill = "Treatment:"
  ) +
  theme(legend.position = "bottom") +
  scale_fill_brewer(palette = "PuOr")
```
 
```{r, echo=TRUE, eval=FALSE}
ggplot(joined_exam_data, aes(x = age, fill = treat)) +
  geom_density(alpha = 0.5) +
  labs(
    title = "Age distribution by treatment",
    x = "Patient age",
    fill = "Treatment:"
  )
```

```{r, echo=FALSE}
ggplot
```
  
This density-plot demonstrates that the age distributions in the two treatment groups are similar, and age distribution does not seem to depend on treatment. There may be a mild tendency for Licorice-treated patients to be older on average, based on the higher peak in the 65–75 age range.  

### **3. Does the age distribution of the patients depend on their sex?**
  
To investigate whether age distribution depend on sex, we created a density plot stratified by `gender`.   

```{r ggplot age gender, include=FALSE}
density_age_distribution_by_gender <- ggplot(
  joined_exam_data,
  aes(x = age, fill = gender)
) +
  geom_density(alpha = 0.5) +
  labs(
    title = "Age distribution by gender",
    x = "Patient age",
    fill = "Gender"
  ) +
  scale_fill_brewer(palette = "Pastel2")
density_age_distribution_by_gender
```
```{r, echo=TRUE, eval=FALSE}
ggplot(joined_exam_data, aes(x = age, fill = gender)) +
  geom_density(alpha = 0.5) +
  labs(
    title = "Age distribution by gender",
    x = "Patient age",
    fill = "Gender"
  )
```
```{r, echo =FALSE}
density_age_distribution_by_gender
```

This density-plot demonstrates that the age distribution does not strongly depend on gender seeing as the density curves overlap substantially.  
    
    
### **4. Does the preoperative pain change with age of the patients?**  

```{r}
ggplot(joined_exam_data, aes(x = age, fill = preOp_pain)) +
  geom_density(alpha = 0.4) +
  labs(
    x = "Age",
    y = "Density"
  )
```
  
This density-plot can indicate difference in age in those experiencing preoperative pain and not. However, only two patients in the dataset reported pre-operative pain.The density curve for the "yes" group therefore represents very few observations and should be interpreted with caution. This explains why the curve looks irregular compared to the "no" group.  
  
To illustrate it in a more approriate way, we made a dotplot. 
```{r}
# Create dataset with one row per participant
patient_data_id_pain_age <- joined_exam_data %>%
  distinct(patient_id, preOp_pain, age)

# Create the plot with unique participants only
ggplot(patient_data_id_pain_age, aes(x = preOp_pain, y = age)) +
  geom_dotplot(
    binaxis = "y", stackdir = "center", dotsize = 0.8,
    binwidth = 1
  ) +
  labs(
    title = "Age by Pre-Op Pain Status",
    x = "Pre-Op Pain",
    y = "Age"
  ) +
  theme_minimal()
```


The dotplot illustrates that the data is highly imbalanced, and the datamaterial is too limited to answer the question.   



## Statistical analyses
```{r load data, include=FALSE}
library(patchwork)
library(tidyverse)
library(here)
library(broom)
library(lme4)
library(broom.mixed)

# Load data
joined_exam_data <- read_delim(here("data", "joined_exam_data_2025-09-09.txt"))

# Mutate from character to factor
joined_exam_data <- joined_exam_data %>%
  mutate(across(where(is.character), as.factor))
```

In this section, we investigate three main questions:

  1. Does the treatment depend on the preoperative smoking?
  2. Does the treatment depend on the gender of the patient?  
  3. According to the data, was the treatment with licorice gargle reducing the risk of post operative throat pain?

The variables and their respective levels involved in these questions are:

- `smoking`: current, past, never
- `gender`: Male, Female  
- `treat`: Licorice, Sugar
- `time`: pacu30min, pacu90min, postOp4hour, pod1am
- `throatPain`: Assessed on a 11-point Likert scale (0 = no pain, 10 = worst pain)

### Does the treatment depend on the preoperative smoking?
In order to answer this, we first created a table for visual inspection of how `smoking` status was distributed across `treat`. 

```{r treatment-smoking table, echo=TRUE}
# Create dataset with one row per participant
patient_level_data <- joined_exam_data %>%
  distinct(patient_id, treat, smoking, gender, age, BMI)

# Table of treatment (rows) by smoking (columns) - one per patient
table(patient_level_data$treat, patient_level_data$smoking) %>%
  knitr::kable(
    caption = "Treatment Distribution by Smoking Status",
    col.names = c("Current", "Never", "Past")
  )
```
On face value, it seems as though the distribution of `smoking` status is evenly distributed between the `treat` conditions. However, we can also test this using a chi-squared test!

```{r chi-squared test treat-smoking, echo=TRUE}
chisq.test(table(patient_level_data$treat, patient_level_data$smoking)) %>%
  tidy() %>%
  knitr::kable(
    digits = 3,
    col.names = c("Chi-square", "p-value", "df", "Method"),
    caption = "Association between Treatment and Smoking Status"
  )
```
The chi-squared statistic was 0.009 (p = 0.995), showing that the treatment is not dependent of smoking status.

### Does the treatment depend on the gender of the patient?
Similary to the previous analysis, we can conduct a chi-squared test of `treat` and `gender`. 

```{r table treat-gender, echo=TRUE}
## Table of treatment (rows) by gender (columns) - one per patient
table(patient_level_data$treat, patient_level_data$gender) %>%
  knitr::kable(
    caption = "Treatment Distribution by Gender",
    col.names = c("Female", "Male")
  )
```

The distribution of `gender` by received `treat` seems even, but we also wish to test this using a chi-squared test.

```{r chi-square treat-gender, echo=TRUE}
chisq_treat_gender_result <- chisq.test(table(patient_level_data$treat, patient_level_data$gender)) %>%
  tidy() %>%
  rename(
    chi_square = statistic,
    degrees_of_freedom = parameter
  ) %>%
  knitr::kable(
    digits = 3,
    col.names = c("Chi-square", "p-value", "df", "Method"),
    caption = "Association between Treatment and Gender"
  )

chisq_treat_gender_result
```
This chi-squared test was insignificant (p = 0.631), indicating that the groups are evenly distributed across `treat` and `gender`.

### Was the treatment with licorice gargle reducing the risk of post operative throat pain?

We have three variables of interest to answer this question:

- `treat`: Licorice or Sugar. 
- `throatPain`: Assessed on a 11-point Likert scale (0 = no pain, 10 = worst pain).
- `time`: Post operative throat pain was assessed at 4 hours after operation and the first morning after operation. 

#### A simple approach
We investigated if the patients reported different pain scores at postOp4hour.

First, we created a histogram to see the distribution of throatPain scores at postOp4hour.

```{r pain distribution, echo=TRUE, warning=FALSE}
# Filter to 4-hour timepoint only
postOp4h_data <- joined_exam_data %>%
  filter(time == "postOp4hour")

# Create plot
ggplot(postOp4h_data, aes(x = throatPain)) +
  geom_histogram(binwidth = 1) +
  facet_wrap(~treat) +
  labs(title = "Distribution of throatPain at postOp4hour")
```

The pain values are highly skewed, with many patients reporting 0 throatPain in both treatment conditions. Due to the pain scores not being normally distributed, a Wilcoxon rank sum test is appropriate.

```{r wilcox throatPain-postOp4hour, echo=TRUE}
# Descriptive statistics by treatment
postOp4h_data %>%
  group_by(treat) %>%
  summarise(
    mean_pain = mean(throatPain, na.rm = TRUE),
    median_pain = median(throatPain, na.rm = TRUE),
    prop_no_pain = mean(throatPain == 0, na.rm = TRUE),
    n = n()
  ) %>%
  knitr::kable(
    digits = 3,
    caption = "Throat Pain at 4 Hours Post-Operation by Treatment"
  )

# Wilcoxon rank sum test
wilcox.test(throatPain ~ treat, data = postOp4h_data) %>%
  tidy() %>%
  knitr::kable(
    digits = 4,
    col.names = c("Statistic", "p-value", "Method", "Alternative"),
    caption = "Wilcoxon Test: Treatment Effect at 4 Hours"
  )
```

At 4 hours post-operation, patients in the licorice group experienced lower throat pain compared to the sugar group. The licorice group had a mean pain score of 0.35 (median = 0), while the sugar group had a mean pain score of 0.91 (median = 0). Notably, 79.5% of patients receiving licorice gargle reported no throat pain, compared to 55.2% in the sugar group. The Wilcoxon rank sum test showed a statistically significant difference in throat pain scores between treatment groups (W = 5109.5, p = 0.0001).

#### A more complex approach
In order to investigate if licorice reduced the risk of post operative throat pain, we can conduct a regression analysis of how `treat` affects `throatPain` over `time`.

```{r lmm throatpain-time-treat, echo=TRUE}
# Mixed effects model with all timepoints
throat_model <- lmer(throatPain ~ treat * time + (1 | patient_id),
  data = joined_exam_data
)

# Tidy results focusing on treatment effects
tidy(throat_model, effects = "fixed") %>%
  knitr::kable(digits = 3, caption = "Mixed effects model results")

# Full model summary
summary(throat_model)
```
The model showed a significant main effect of treatment (β = 0.752, t = 5.496), indicating that sugar treatment increases throat pain by approximately 0.75 points compared to licorice across all time points.

We can also visualize this using ggplot2:

```{r visualizing treat-time-throatPain, echo=TRUE, warning=FALSE}
# Ensure correct time order
joined_exam_data$time <- factor(joined_exam_data$time,
  levels = c("pacu30min", "pacu90min", "postOp4hour", "pod1am")
)

# Plot
joined_exam_data %>%
  group_by(treat, time) %>%
  summarise(
    mean_pain = mean(throatPain, na.rm = TRUE),
    se_pain = sd(throatPain, na.rm = TRUE) / sqrt(n()),
    .groups = "drop"
  ) %>%
  ggplot(aes(x = time, y = mean_pain, color = treat, group = treat)) +
  geom_line(linewidth = 0.5) +
  geom_point(size = 3) +
  geom_errorbar(aes(ymin = mean_pain - se_pain, ymax = mean_pain + se_pain),
    width = 0.1
  ) +
  labs(
    x = "Time point",
    y = "Throat pain score (mean)",
    color = "Treatment",
    title = "Throat pain over time by treatment"
  ) +
  theme_minimal() +
  scale_color_brewer(palette = "Set2")
```


## Session info


```{r}
sessionInfo()
```
